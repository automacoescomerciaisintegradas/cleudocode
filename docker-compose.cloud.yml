# ============================================================
# CLEUDO CODE - Docker Compose para Docker Offload / Cloud
# ============================================================
# Este arquivo é otimizado para deploy via Docker Offload
# que permite executar builds e containers em cloud remoto.
#
# Para usar com Docker Offload:
#   1. Ative o Docker Offload no Docker Desktop
#   2. docker compose -f docker-compose.cloud.yml up -d
# ============================================================

name: cleudocode-cloud

services:
  # ============ CLEUDO CODE - Aplicação Principal ============
  cleudocode:
    image: automacoescomerciais/cleudocode:latest
    container_name: cleudocode-app

    # Build settings (usado se não encontrar a imagem)
    build:
      context: .
      dockerfile: Dockerfile
      # Cache para builds mais rápidos
      cache_from:
        - automacoescomerciais/cleudocode:latest
      # Labels para Docker Offload
      labels:
        - "com.docker.offload=true"
        - "com.docker.offload.priority=high"

    # Restart policy para produção
    restart: always

    # Portas expostas
    ports:
      - "8501:8501"

    # Variáveis de ambiente
    environment:
      # Ollama Server (configure com seu servidor)
      - OLLAMA_HOST=${OLLAMA_HOST:-http://ollama:11434}
      - DEEPSEEK_MODEL=${DEEPSEEK_MODEL:-qwen2.5-coder:7b}

      # Streamlit Configuration
      - STREAMLIT_SERVER_PORT=8501
      - STREAMLIT_SERVER_ADDRESS=0.0.0.0
      - STREAMLIT_SERVER_HEADLESS=true
      - STREAMLIT_BROWSER_GATHER_USAGE_STATS=false
      - STREAMLIT_SERVER_ENABLE_CORS=true
      - STREAMLIT_SERVER_ENABLE_XSRF_PROTECTION=false

      # Python settings
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1

    # Volumes para persistência
    volumes:
      - cleudocode-exports:/app/exports
      - cleudocode-uploads:/app/uploads
      - cleudocode-memory:/app/memory_db
      - cleudocode-agents:/app/agents

    # Dependências
    depends_on:
      ollama:
        condition: service_healthy
        required: false

    # Rede
    networks:
      - cleudocode-network

    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8501/_stcore/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

    # Labels para identificação
    labels:
      - "app=cleudocode"
      - "version=0.50.0"
      - "maintainer=cleudocode.automacoescomerciais.com.br"

    # Recursos (ajuste conforme necessário)
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 2G
        reservations:
          cpus: "0.5"
          memory: 512M
      # Rollback automático
      rollback_config:
        parallelism: 1
        delay: 10s
      # Update config
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback

  # ============ OLLAMA - Servidor LLM (Opcional) ============
  ollama:
    image: ollama/ollama:latest
    container_name: ollama-server
    restart: always

    ports:
      - "11434:11434"

    volumes:
      - ollama-data:/root/.ollama

    environment:
      - OLLAMA_HOST=0.0.0.0
      - OLLAMA_ORIGINS=*

    networks:
      - cleudocode-network

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11434/api/version"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

    # GPU Support (descomente se disponível)
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: 1
    #           capabilities: [gpu]

    labels:
      - "app=ollama"
      - "service=llm"

  # ============ NGINX - Reverse Proxy (Opcional) ============
  nginx:
    image: nginx:alpine
    container_name: cleudocode-nginx
    restart: always

    ports:
      - "80:80"
      - "443:443"

    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro

    depends_on:
      - cleudocode

    networks:
      - cleudocode-network

    profiles:
      - with-proxy

    labels:
      - "app=nginx"
      - "service=proxy"

# ============ NETWORKS ============
networks:
  cleudocode-network:
    driver: bridge
    name: cleudocode-net
    labels:
      - "app=cleudocode"

# ============ VOLUMES ============
volumes:
  cleudocode-exports:
    name: cleudocode-exports
    labels:
      - "app=cleudocode"
      - "data=exports"

  cleudocode-uploads:
    name: cleudocode-uploads
    labels:
      - "app=cleudocode"
      - "data=uploads"

  cleudocode-memory:
    name: cleudocode-memory
    labels:
      - "app=cleudocode"
      - "data=rag-memory"

  cleudocode-agents:
    name: cleudocode-agents
    labels:
      - "app=cleudocode"
      - "data=agents"

  ollama-data:
    name: ollama-data
    labels:
      - "app=ollama"
      - "data=models"
